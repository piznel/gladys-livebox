!function(){"use strict";function e(e,n,r,t,c){var i=this;function u(e,n,r){var c;i.displayAskDeviceForm=!1,i.deviceId=e,i.currentDeviceName=n,i.ipSelectedDevice=r,i.channels=new Array,t({method:"get",url:"./hooks/livebox/data/channels.json",dataType:"json",contentType:"application/json"}).success(function(e){i.channels=e.orange}).error(function(){}),c=i.deviceId,i.devicetypes.map(function(e){"Power"===e.identifier&&e.deviceId===c&&(i.currentPowerState=e.lastValue,i.devicePowerId=e.id)})}i.devices=[],i.devicetypes=[],i.deviceId=null,i.displayAskDeviceForm=!1,i.currentDeviceName="",i.currentChannel="",i.currentUrl="",i.ipSelectedDevice="",i.currentPowerState=0,i.currentEpg="",i.init=function(e){return i.boxId=e,r.getById(e).then(function(e){i.box=e.data,n.get(void 0,void 0,"livebox").then(function(e){return n=e.data,new Promise(function(e,r){return n.forEach(function(e){i.devices.push({id:e.id,name:e.name,ip:e.identifier})}),e(i.devices)});var n}).then(function(e){return r=e,new Promise(function(e,t){return r.map(function(r){return n.getDeviceTypesDevice(r.id).then(function(n){return n.data.map(function(e){i.devicetypes.push({id:e.id,identifier:e.identifier,lastValue:e.lastValue,deviceId:r.id})}),e(i.devicetypes)})})});var r}).then(function(e){i.box.params&&i.box.params.deviceId?u(i.box.params.deviceId,i.box.params.name,i.box.params.ip):i.displayAskDeviceForm=!0})}),io.socket.on("newDeviceState",function(e){e.devicetype===i.devicePowerId&&(i.currentPowerState=e.value,"0"===i.currentPowerState&&(i.currentUrl="",i.currentChannel=""),c.$apply())}),void io.socket.on("livebox-channel",function(e){if(i.ipSelectedDevice==e.ip){var n=i.channels.filter(function(n){return n.epg===e.channel});1===n.length&&(i.currentChannel=n[0].name,i.currentUrl=n[0].url,i.currentEpg=n[0].epg,c.$apply())}})},i.switchState=function(){return e.switchState({device:i.deviceId,state:!i.currentPowerState,deviceTypeId:i.devicePowerId}).then(function(){i.currentPowerState?(i.currentChannel="Mosa√Øque Orange",i.currentUrl="hooks/livebox/img/orange_small.png",i.currentEpg=0):(i.currentChannel="",i.currentUrl="",i.currentEpg="")})},i.setMuted=function(){return e.setMuted({device:i.deviceId,state:!i.currentMuteState}).then(function(){})},i.volumeUp=function(){return e.volumeUp({device:i.deviceId}).then(function(){})},i.volumeDown=function(){return e.volumeDown({device:i.deviceId}).then(function(){})},i.pressKey=function(n){return e.pressKey({device:i.deviceId,key:"epg:"+n}).then(function(e){i.currentEpg=n,i.currentPowerState||(i.currentPowerState=!i.currentPowerState)})},i.programVod=function(){return e.programVod({device:i.deviceId,controlType:"programVod"}).then(function(){})},i.programPlus=function(){if(""!==i.currentEpg){var n=i.channels.findIndex(function(e){return e.epg===i.currentEpg});return n+1<i.channels.length?e.pressKey({device:i.deviceId,key:"epg:"+i.channels[n+1].epg}).then(function(){i.currentChannel=i.channels[n+1].name,i.currentUrl=i.channels[n+1].url,i.currentEpg=i.channels[n+1].epg}):e.pressKey({device:i.deviceId,key:"epg:"+i.channels[1].epg}).then(function(){i.currentChannel=i.channels[1].name,i.currentUrl=i.channels[1].url,i.currentEpg=i.channels[1].epg})}},i.programMinus=function(){if(""!==i.currentEpg){var n=i.channels.findIndex(function(e){return e.epg===i.currentEpg});return n>1?e.pressKey({device:i.deviceId,key:"epg:"+i.channels[n-1].epg}).then(function(){i.currentChannel=i.channels[n-1].name,i.currentUrl=i.channels[n-1].url,i.currentEpg=i.channels[n-1].epg}):e.pressKey({device:i.deviceId,key:"epg:"+i.channels[i.channels.length-1].epg}).then(function(){i.currentChannel=i.channels[i.channels.length-1].name,i.currentUrl=i.channels[i.channels.length-1].url,i.currentEpg=i.channels[i.channels.length-1].epg})}},i.selectDevice=function(e){"string"==typeof e&&(e=JSON.parse(e));r.update(i.boxId,{params:{deviceId:e.id,name:e.name,ip:e.ip}}),u(e.id,e.name,e.ip)}}angular.module("gladys").controller("liveboxboxCtrl",e),e.$inject=["televisionService","deviceService","boxService","$http","$scope"]}();